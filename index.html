<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản lý Đăng ký Đa năng</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font: Inter -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- SheetJS CDN for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Phosphor Icons for a clean look -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .tab-button.active {
            border-color: #3B82F6;
            color: #2563EB;
            font-weight: 600;
        }
        input:not([type="radio"]):not([type="checkbox"]), select, textarea {
            transition: all 0.2s;
            border-color: #d1d5db;
        }
        input:not([type="radio"]):not([type="checkbox"]):hover, select:hover, textarea:hover {
            border-color: #9ca3af;
        }
        input:not([type="radio"]):not([type="checkbox"]):focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .truncate-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 250px;
            display: inline-block;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Loading Spinner -->
    <div id="loading" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300 hidden">
        <div class="flex flex-col items-center">
            <svg class="animate-spin h-10 w-10 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-blue-600 font-medium">Đang tải...</span>
        </div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900 bg-opacity-40 transition-opacity duration-300 hidden">
        <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full">
            <p id="message-text" class="text-center font-medium text-gray-800 mb-4"></p>
            <div class="flex justify-center">
                <button id="close-message" class="bg-blue-600 text-white rounded-full px-6 py-2 font-semibold shadow-md hover:bg-blue-700 transition-colors">OK</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md sm:max-w-xl lg:max-w-3xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-600" id="main-title">Hệ thống Quản lý Đăng ký</h1>

        <!-- Admin Login Panel -->
        <div id="login-panel" class="hidden">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">Đăng nhập Admin</h2>
            <p class="text-sm text-center text-gray-600 mb-6">Sử dụng User ID của tài khoản quản trị viên.</p>
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="admin-user-id" class="block text-sm font-bold text-gray-700">User ID</label>
                    <input type="text" id="admin-user-id" required class="mt-1 block w-full rounded-lg border-2 border-gray-400 p-3" placeholder="Dán User ID của bạn vào đây">
                </div>
                <div>
                    <button type="submit" class="w-full bg-blue-600 text-white rounded-full py-3 px-8 font-semibold shadow-md hover:bg-blue-700 transition-colors">Đăng nhập</button>
                </div>
            </form>
        </div>

        <!-- Admin Dashboard Panel -->
        <div id="admin-panel" class="hidden">
            <div class="flex mb-6">
                <button id="tab-create" class="tab-button active flex-1 py-3 px-4 text-center text-sm transition-colors duration-200 focus:outline-none border-b-2 border-transparent">
                    Tạo Link Đăng ký Mới
                </button>
                <button id="tab-view" class="tab-button flex-1 py-3 px-4 text-center text-sm transition-colors duration-200 focus:outline-none border-b-2 border-transparent">
                    Xem Dữ liệu Đăng ký
                </button>
            </div>

            <!-- Create New Form Section -->
            <div id="create-form-section" class="space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Tạo Form Đăng ký Mới</h2>
                <div>
                    <label for="campaign-title" class="block text-sm font-bold text-gray-700">Tiêu đề Chiến dịch</label>
                    <input type="text" id="campaign-title" required class="mt-1 block w-full rounded-lg border-2 border-gray-400 p-3">
                </div>
                <div>
                    <label for="campaign-description" class="block text-sm font-bold text-gray-700">Mô tả (tùy chọn)</label>
                    <textarea id="campaign-description" rows="3" class="mt-1 block w-full rounded-lg border-2 border-gray-400 p-3" placeholder="Ví dụ: Đăng ký mua đồng phục năm học 2024-2025."></textarea>
                </div>
                <div class="border-t border-gray-200 pt-4">
                    <h3 class="text-md font-bold text-gray-700 mb-2">Tùy chọn đăng ký</h3>
                    <div id="options-list" class="space-y-4">
                        <!-- Dynamic options will be added here -->
                    </div>
                    <button type="button" id="add-option-btn" class="mt-4 flex items-center bg-gray-200 text-gray-700 rounded-full py-2 px-4 font-semibold hover:bg-gray-300 transition-colors">
                        <i class="ph ph-plus-circle text-lg mr-2"></i>Thêm tùy chọn
                    </button>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="require-notes" class="rounded-full text-blue-600 focus:ring-blue-500">
                    <label for="require-notes" class="text-sm text-gray-700">Yêu cầu nhập ghi chú/địa chỉ (tùy chọn)</label>
                </div>
                <div>
                    <button id="create-campaign-btn" class="w-full bg-green-600 text-white rounded-full py-3 px-8 font-semibold shadow-md hover:bg-green-700 transition-colors">Tạo Link</button>
                </div>
                <div id="generated-link-section" class="mt-6 p-4 bg-gray-100 rounded-xl hidden">
                    <p class="text-sm text-gray-700 font-medium mb-2">Đường link đã tạo:</p>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="generated-link" class="flex-1 p-2 rounded-lg bg-white border border-gray-300 text-sm" readonly>
                        <button id="copy-link-btn" class="bg-blue-600 text-white rounded-full p-2 hover:bg-blue-700 transition-colors">
                            <i class="ph ph-copy text-lg"></i>
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Sao chép và chia sẻ đường link này cho học sinh đăng ký.</p>
                </div>
            </div>

            <!-- View Existing Forms Section -->
            <div id="view-forms-section" class="hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Các Chiến dịch Đã Tạo</h2>
                <div id="campaigns-list" class="space-y-4">
                    <!-- Campaigns will be listed here -->
                </div>
            </div>

            <!-- Specific Campaign Data View Section -->
            <div id="campaign-data-section" class="hidden">
                <div class="flex items-center mb-4 space-x-4">
                    <button id="back-to-campaigns-btn" class="bg-gray-200 text-gray-700 rounded-full py-2 px-4 font-semibold hover:bg-gray-300 transition-colors">
                        <i class="ph ph-arrow-left text-lg"></i>
                    </button>
                    <h2 id="campaign-data-title" class="text-xl font-bold text-gray-800"></h2>
                    <button id="export-excel-btn" class="ml-auto bg-purple-600 text-white rounded-full py-2 px-4 font-semibold shadow-md hover:bg-purple-700 transition-colors">
                        Xuất Excel
                    </button>
                </div>
                <div class="overflow-x-auto rounded-xl shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr id="data-table-headers">
                                <!-- Headers will be generated dynamically -->
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Student Registration Form Panel -->
        <div id="student-form-panel" class="hidden p-4">
            <h2 id="student-form-title" class="text-2xl font-bold text-center mb-2 text-blue-600"></h2>
            <p id="student-form-description" class="text-sm text-center text-gray-600 mb-6"></p>

            <form id="student-registration-form" class="space-y-6">
                <div>
                    <label for="student-name" class="block text-sm font-bold text-gray-700">Họ và Tên</label>
                    <input type="text" id="student-name" required class="mt-1 block w-full rounded-lg border-2 border-gray-400 p-3">
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Ngày sinh</label>
                    <div class="mt-1 flex space-x-2">
                        <select id="dob-day" required class="w-1/3 rounded-lg border-2 border-gray-400 p-3">
                            <option value="">Ngày</option>
                        </select>
                        <select id="dob-month" required class="w-1/3 rounded-lg border-2 border-gray-400 p-3">
                            <option value="">Tháng</option>
                        </select>
                        <select id="dob-year" required class="w-1/3 rounded-lg border-2 border-gray-400 p-3">
                            <option value="">Năm</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700">Giới tính</label>
                    <div class="mt-2 flex space-x-6">
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="Nam" required class="form-radio h-5 w-5 text-blue-600">
                            <span class="ml-2 text-gray-700">Nam</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="gender" value="Nữ" required class="form-radio h-5 w-5 text-blue-600">
                            <span class="ml-2 text-gray-700">Nữ</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="student-class" class="block text-sm font-bold text-gray-700">Lớp</label>
                    <select id="student-class" required class="mt-1 block w-full rounded-lg border-2 border-gray-400 p-3">
                        <option value="">Chọn lớp</option>
                    </select>
                </div>
                
                <div id="dynamic-options-container" class="space-y-6">
                    <!-- Dynamic options will be rendered here -->
                </div>
                
                <div id="notes-section" class="space-y-2 hidden">
                    <label for="notes" class="block text-sm font-bold text-gray-700">Ghi chú (tùy chọn)</label>
                    <textarea id="notes" rows="3" class="mt-1 block w-full rounded-lg border-2 border-gray-400 p-3" placeholder="Thêm ghi chú của bạn nếu cần."></textarea>
                </div>

                <div class="text-center">
                    <button type="submit" id="student-submit-btn" class="w-full bg-blue-600 text-white rounded-full py-3 px-8 font-semibold shadow-md hover:bg-blue-700 transition-colors">Gửi Đăng ký</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, setDoc, addDoc, serverTimestamp, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Global Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAtjEr4TbDsLHdycc8bHhlTN3Ovw4zYM5g",
            authDomain: "a2-b43d6.firebaseapp.com",
            projectId: "a2-b43d6",
            storageBucket: "a2-b43d6.firebasestorage.app",
            messagingSenderId: "19454507527",
            appId: "1:19454507527:web:94684e3d57015c202408a2"
        };
        const appId = "a2-b43d6"; // Hardcode appId based on your config
        // Dán User ID của bạn vào đây để cấp quyền quản trị.
        // Bạn có thể tìm thấy ID này trong Firebase Console -> Authentication.
        const adminUserId = "cyWIU5DcVgfRnwzreuhbytsF54q1"; // Dán ID của bạn vào giữa cặp dấu nháy kép này

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
    
        // Global variables
        let uid = null;
        let isAdmin = false;
        let currentCampaignId = null;
        
        // DOM Elements
        const mainTitle = document.getElementById('main-title');
        const appContainer = document.getElementById('app-container');
        const loading = document.getElementById('loading');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message');
        
        // Panels
        const loginPanel = document.getElementById('login-panel');
        const loginForm = document.getElementById('login-form');
        const adminUserIdInput = document.getElementById('admin-user-id');
        const adminPanel = document.getElementById('admin-panel');
        const studentFormPanel = document.getElementById('student-form-panel');
        
        // Admin Elements
        const tabCreate = document.getElementById('tab-create');
        const tabView = document.getElementById('tab-view');
        const createFormSection = document.getElementById('create-form-section');
        const viewFormsSection = document.getElementById('view-forms-section');
        const campaignTitleInput = document.getElementById('campaign-title');
        const campaignDescriptionInput = document.getElementById('campaign-description');
        const optionsList = document.getElementById('options-list');
        const addOptionBtn = document.getElementById('add-option-btn');
        const requireNotesCheckbox = document.getElementById('require-notes');
        const createCampaignBtn = document.getElementById('create-campaign-btn');
        const generatedLinkSection = document.getElementById('generated-link-section');
        const generatedLinkInput = document.getElementById('generated-link');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const campaignsList = document.getElementById('campaigns-list');
        const campaignDataSection = document.getElementById('campaign-data-section');
        const backToCampaignsBtn = document.getElementById('back-to-campaigns-btn');
        const campaignDataTitle = document.getElementById('campaign-data-title');
        const dataTableHeaders = document.getElementById('data-table-headers');
        const dataTableBody = document.getElementById('data-table-body');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        
        // Student Form Elements
        const studentFormTitle = document.getElementById('student-form-title');
        const studentFormDescription = document.getElementById('student-form-description');
        const studentRegistrationForm = document.getElementById('student-registration-form');
        const studentNameInput = document.getElementById('student-name');
        const dobDaySelect = document.getElementById('dob-day');
        const dobMonthSelect = document.getElementById('dob-month');
        const dobYearSelect = document.getElementById('dob-year');
        const studentClassSelect = document.getElementById('student-class');
        const dynamicOptionsContainer = document.getElementById('dynamic-options-container');
        const notesSection = document.getElementById('notes-section');
        const notesInput = document.getElementById('notes');
        
        // Utility Functions
        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
        }
        function hideMessage() { messageBox.classList.add('hidden'); }
        closeMessageBtn.addEventListener('click', hideMessage);
        
        function showLoading() { loading.classList.remove('hidden'); }
        function hideLoading() { loading.classList.add('hidden'); }
        
        function hideAllPanels() {
            loginPanel.classList.add('hidden');
            adminPanel.classList.add('hidden');
            studentFormPanel.classList.add('hidden');
        }
        
        // Populate DOB dropdowns
        function populateDOB() {
            const currentYear = new Date().getFullYear();
            for (let i = 1; i <= 31; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString().padStart(2, '0');
                dobDaySelect.appendChild(option);
            }
            for (let i = 1; i <= 12; i++) {
                const option = document.createElement('option');
                option.value = i.toString().padStart(2, '0');
                option.textContent = i.toString().padStart(2, '0');
                dobMonthSelect.appendChild(option);
            }
            for (let i = currentYear; i >= 2005; i--) {
                const option = document.createElement('option');
                option.value = i.toString();
                option.textContent = i.toString();
                dobYearSelect.appendChild(option);
            }
        }
        populateDOB();

        // Populate class options
        const classes = ['10A1', '10A2', '10A3', '10A4', '10A5', '10A6', '10A7', '10D1', '10D2', '10D3'];
        classes.forEach(cls => {
            const option = document.createElement('option');
            option.value = cls;
            option.textContent = cls;
            studentClassSelect.appendChild(option);
        });

        // ===================================
        // ADMIN DASHBOARD LOGIC
        // ===================================
        
        // Add option row to admin form
        function addOptionRow(optionName = '', needsQuantity = false) {
            const newOptionDiv = document.createElement('div');
            newOptionDiv.className = 'flex items-center space-x-2';
            newOptionDiv.innerHTML = `
                <input type="text" class="option-name flex-1 p-2 rounded-lg border-2 border-gray-400" placeholder="Tên tùy chọn (ví dụ: Áo ngắn tay và quần)" value="${optionName}">
                <label class="flex items-center text-sm font-medium text-gray-700 whitespace-nowrap">
                    <input type="checkbox" class="needs-quantity rounded-full text-blue-600 mr-1" ${needsQuantity ? 'checked' : ''}> Số lượng
                </label>
                <button type="button" class="remove-option-btn bg-red-500 text-white rounded-full p-2 hover:bg-red-600 transition-colors">
                    <i class="ph ph-trash text-lg"></i>
                </button>
            `;
            optionsList.appendChild(newOptionDiv);
        }
        addOptionBtn.addEventListener('click', () => addOptionRow());
        
        // Remove option row
        optionsList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-option-btn')) {
                e.target.closest('div').remove();
            }
        });
        
        // Create campaign and generate link
        createCampaignBtn.addEventListener('click', async () => {
            const title = campaignTitleInput.value.trim();
            const description = campaignDescriptionInput.value.trim();
            if (!title) {
                showMessage("Vui lòng nhập tiêu đề chiến dịch.");
                return;
            }
            
            showLoading();
            
            const options = [];
            const optionRows = optionsList.querySelectorAll('.option-name');
            optionRows.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    const needsQuantity = input.nextElementSibling.querySelector('.needs-quantity').checked;
                    options.push({ name, needsQuantity });
                }
            });

            if (options.length === 0) {
                showMessage("Vui lòng thêm ít nhất một tùy chọn.");
                hideLoading();
                return;
            }
            
            try {
                const campaignsRef = collection(db, "artifacts", appId, "public", "data", "campaigns");
                const newCampaignDoc = await addDoc(campaignsRef, {
                    title: title,
                    description: description,
                    options: options,
                    requireNotes: requireNotesCheckbox.checked,
                    createdAt: serverTimestamp(),
                });
                
                const campaignId = newCampaignDoc.id;
                // Store the public collection path correctly
                const publicCollectionPath = `artifacts/${appId}/public/data/registrations/${campaignId}/registrations_data`;
                await setDoc(newCampaignDoc, { publicCollectionPath, id: campaignId }, { merge: true });
                
                const generatedLink = `${window.location.origin}${window.location.pathname}?campaignId=${campaignId}`;
                generatedLinkInput.value = generatedLink;
                generatedLinkSection.classList.remove('hidden');
                
                showMessage("Đã tạo chiến dịch thành công!");
                
            } catch (error) {
                showMessage("Lỗi khi tạo chiến dịch: " + error.message);
                console.error("Lỗi khi tạo chiến dịch:", error);
            } finally {
                hideLoading();
            }
        });
        
        // Copy link to clipboard
        copyLinkBtn.addEventListener('click', () => {
            generatedLinkInput.select();
            document.execCommand('copy');
            showMessage("Đã sao chép đường link!");
        });
        
        // Switch between create and view tabs
        tabCreate.addEventListener('click', () => {
            tabCreate.classList.add('active');
            tabView.classList.remove('active');
            createFormSection.classList.remove('hidden');
            viewFormsSection.classList.add('hidden');
            campaignDataSection.classList.add('hidden');
        });
        
        tabView.addEventListener('click', () => {
            tabView.classList.add('active');
            tabCreate.classList.remove('active');
            createFormSection.classList.add('hidden');
            campaignDataSection.classList.add('hidden');
            viewFormsSection.classList.remove('hidden');
            listenForCampaigns();
        });

        // Listen for existing campaigns
        function listenForCampaigns() {
            const campaignsRef = collection(db, "artifacts", appId, "public", "data", "campaigns");
            const q = query(campaignsRef, orderBy('createdAt', 'desc'));

            onSnapshot(q, (snapshot) => {
                campaignsList.innerHTML = '';
                if (snapshot.empty) {
                    campaignsList.innerHTML = `<p class="text-center text-gray-500">Chưa có chiến dịch nào được tạo.</p>`;
                }
                snapshot.forEach(doc => {
                    const campaign = doc.data();
                    const campaignDiv = document.createElement('div');
                    campaignDiv.className = 'bg-gray-100 p-4 rounded-xl flex items-center justify-between shadow-sm';
                    campaignDiv.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${campaign.title}</p>
                            <p class="text-xs text-gray-500">Tạo lúc: ${new Date(campaign.createdAt.toDate()).toLocaleString()}</p>
                        </div>
                        <button class="view-data-btn bg-blue-600 text-white rounded-full py-2 px-4 font-semibold hover:bg-blue-700 transition-colors text-sm" data-id="${doc.id}">
                            Xem dữ liệu
                        </button>
                    `;
                    campaignsList.appendChild(campaignDiv);
                });
            }, (error) => {
                showMessage("Lỗi khi lấy danh sách chiến dịch: " + error.message);
            });
        }
        
        // Handle view data button click
        campaignsList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('view-data-btn')) {
                const campaignId = e.target.dataset.id;
                showCampaignData(campaignId);
            }
        });

        backToCampaignsBtn.addEventListener('click', () => {
            campaignDataSection.classList.add('hidden');
            viewFormsSection.classList.remove('hidden');
        });

        let currentData = [];

        async function showCampaignData(campaignId) {
            showLoading();
            const campaignDocRef = doc(db, "artifacts", appId, "public", "data", "campaigns", campaignId);
            const campaignDoc = await getDoc(campaignDocRef);
            if (!campaignDoc.exists()) {
                showMessage("Không tìm thấy chiến dịch này.");
                hideLoading();
                return;
            }
            const campaign = campaignDoc.data();
            currentCampaignId = campaign.id;

            campaignDataTitle.textContent = campaign.title;
            viewFormsSection.classList.add('hidden');
            campaignDataSection.classList.remove('hidden');
            
            const registrationCollectionRef = collection(db, campaign.publicCollectionPath);
            onSnapshot(registrationCollectionRef, (snapshot) => {
                dataTableHeaders.innerHTML = '';
                dataTableBody.innerHTML = '';
                
                // Build headers dynamically
                let headers = ['STT', 'Họ và Tên', 'Ngày sinh', 'Giới tính', 'Lớp'];
                campaign.options.forEach(opt => headers.push(opt.name));
                if (campaign.requireNotes) headers.push('Ghi chú');
                
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider';
                    th.textContent = header;
                    dataTableHeaders.appendChild(th);
                });

                currentData = [];
                snapshot.forEach((doc, index) => {
                    const registration = doc.data();
                    currentData.push(registration);
                    
                    const row = document.createElement('tr');
                    let cells = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${index + 1}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${registration.fullName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registration.dob}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registration.gender}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${registration.class}</td>
                    `;
                    campaign.options.forEach(opt => {
                        const value = registration.options[opt.name];
                        if (opt.needsQuantity) {
                           cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${value || '0'}</td>`;
                        } else {
                           cells += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${value ? 'Có' : 'Không'}</td>`;
                        }
                    });
                    if (campaign.requireNotes) {
                        cells += `<td class="px-6 py-4 text-sm text-gray-500"><span class="truncate-text">${registration.notes || ''}</span></td>`;
                    }
                    row.innerHTML = cells;
                    dataTableBody.appendChild(row);
                });
                hideLoading();
            }, (error) => {
                showMessage("Lỗi khi lấy dữ liệu đăng ký: " + error.message);
                hideLoading();
            });
        }

        // Export data to Excel
        exportExcelBtn.addEventListener('click', () => {
            if (currentData.length === 0) {
                showMessage("Không có dữ liệu để xuất.");
                return;
            }

            const dataToExport = currentData.map(d => {
                const flatData = {
                    "Họ và Tên": d.fullName,
                    "Ngày sinh": d.dob,
                    "Giới tính": d.gender,
                    "Lớp": d.class,
                };
                for (const key in d.options) {
                    flatData[key] = d.options[key];
                }
                if (d.notes) {
                    flatData["Ghi chú"] = d.notes;
                }
                return flatData;
            });

            const workSheet = XLSX.utils.json_to_sheet(dataToExport);
            const workBook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workBook, workSheet, "Dữ liệu đăng ký");
            XLSX.writeFile(workBook, `dang_ky_${currentCampaignId}.xlsx`);
            
            showMessage("Đã xuất file Excel thành công!");
        });

        // ===================================
        // STUDENT FORM LOGIC
        // ===================================

        async function loadStudentForm(campaignId) {
            showLoading();
            const campaignDocRef = doc(db, "artifacts", appId, "public", "data", "campaigns", campaignId);
            const campaignDoc = await getDoc(campaignDocRef);
            
            if (!campaignDoc.exists()) {
                showMessage("Không tìm thấy form đăng ký. Vui lòng kiểm tra lại đường link.");
                hideLoading();
                return;
            }

            const campaignData = campaignDoc.data();
            currentCampaignId = campaignId; // Store the ID
            
            studentFormTitle.textContent = campaignData.title;
            studentFormDescription.textContent = campaignData.description;

            // Dynamically create options
            dynamicOptionsContainer.innerHTML = '';
            campaignData.options.forEach(opt => {
                const optionDiv = document.createElement('div');
                if (opt.needsQuantity) {
                    // Option with quantity input
                    optionDiv.className = 'flex items-center space-x-2';
                    optionDiv.innerHTML = `
                        <label for="option-${opt.name}" class="text-sm font-bold text-gray-700 w-3/4">${opt.name}</label>
                        <input type="number" id="option-${opt.name}" name="option-${opt.name}" class="option-input flex-1 p-2 rounded-lg border-2 border-gray-400" min="0" value="0">
                    `;
                } else {
                    // Option with checkbox
                    optionDiv.className = 'flex items-center space-x-2';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="option-${opt.name}" name="option-${opt.name}" class="option-checkbox rounded-full text-blue-600">
                        <label for="option-${opt.name}" class="text-sm font-bold text-gray-700">${opt.name}</label>
                    `;
                }
                dynamicOptionsContainer.appendChild(optionDiv);
            });
            
            if (campaignData.requireNotes) {
                notesSection.classList.remove('hidden');
            } else {
                notesSection.classList.add('hidden');
            }

            hideLoading();
            studentFormPanel.classList.remove('hidden');
        }
        
        // Handle student form submission
        studentRegistrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            showLoading();
            
            const dob = `${dobYearSelect.value}-${dobMonthSelect.value}-${dobDaySelect.value}`;
            const selectedGender = document.querySelector('input[name="gender"]:checked')?.value;
            
            const optionsData = {};
            const optionInputs = document.querySelectorAll('#dynamic-options-container .option-input');
            optionInputs.forEach(input => {
                const name = input.id.replace('option-', '');
                optionsData[name] = parseInt(input.value) || 0;
            });
            
            const optionCheckboxes = document.querySelectorAll('#dynamic-options-container .option-checkbox');
            optionCheckboxes.forEach(checkbox => {
                const name = checkbox.id.replace('option-', '');
                optionsData[name] = checkbox.checked;
            });
            
            const registrationData = {
                fullName: studentNameInput.value,
                dob: dob,
                gender: selectedGender,
                class: studentClassSelect.value,
                options: optionsData,
                notes: notesInput.value,
                submittedAt: serverTimestamp(),
            };
            
            if (!currentCampaignId) {
                showMessage("Đang có lỗi xảy ra. Vui lòng thử lại.");
                hideLoading();
                return;
            }
            
            try {
                // Get the campaign's collection path
                const campaignDocRef = doc(db, "artifacts", appId, "public", "data", "campaigns", currentCampaignId);
                const campaignDoc = await getDoc(campaignDocRef);
                const collectionPath = campaignDoc.data().publicCollectionPath;

                // Add data to the specific campaign collection
                const newRegistrationRef = await addDoc(collection(db, collectionPath), registrationData);
                
                showMessage("Đăng ký của bạn đã được gửi thành công. Cảm ơn bạn!");
                studentRegistrationForm.reset();
                
            } catch (error) {
                showMessage("Lỗi khi gửi đăng ký: " + error.message);
                console.error("Lỗi khi gửi đăng ký:", error);
            } finally {
                hideLoading();
            }
        });

        // ===================================
        // INITIALIZATION AND ROUTING
        // ===================================
        
        // Handle login form submission
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputUserId = adminUserIdInput.value.trim();
            if (inputUserId === adminUserId) {
                // Correct ID, show admin panel
                loginPanel.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                tabCreate.click();
            } else {
                showMessage("User ID không hợp lệ. Vui lòng thử lại.");
            }
        });
        
        const urlParams = new URLSearchParams(window.location.search);
        const campaignId = urlParams.get('campaignId');
            
        if (campaignId) {
            // User is accessing a specific form link
            hideAllPanels();
            mainTitle.textContent = "Form Đăng ký";
            loadStudentForm(campaignId);
        } else {
            // User is on the main page, show login panel
            hideAllPanels();
            loginPanel.classList.remove('hidden');
        }
        
    </script>
</body>
</html>

